# Session 2026-02-14 — PDF Project
## Context snapshot
- Elasticsearch indexing was the only pipeline phase without status tracking or retry support.
- OCR and enrichment already had `_IN_PROGRESS`, `_COMPLETED`, `_ERROR` statuses plus retry fields and recovery scheduler integration.
- Goal: bring indexing to parity with OCR/enrichment for observability and resilience.

## Problems encountered
- Hibernate `ddl-auto: update` failed to add `indexing_retry_count` column because existing rows had NULL values for a `NOT NULL int` column. Fix: manually run `ALTER TABLE ... ADD COLUMN ... DEFAULT 0 NOT NULL` before Hibernate picks it up.
- `TessOcrExtractionStrategyImpl` missing `@Component` — discovered it's not an oversight per se, but an implicit design choice: the OCR adapter requires Tesseract installed on the host, so leaving it unregistered avoids runtime failures when Tesseract isn't available. A cleaner approach would be `@ConditionalOnProperty`.

## Decisions made
- Decision: Add `INDEXING_IN_PROGRESS`, `INDEXING_COMPLETED`, `INDEXING_ERROR` to `Document.Status` enum.
    - Why: Indexing failures were silent — no status, no retry, no visibility.
    - Alternatives: Could have kept indexing as fire-and-forget and relied on manual re-indexing.
    - Consequences: Full pipeline now has end-to-end status tracking; DB schema gains 3 new columns.
    - Status: Adopted

- Decision: Create a separate `DocumentIndexingEvent` (not reuse `DocumentEnrichedEvent`) for retry dispatch.
    - Why: Re-publishing `DocumentEnrichedEvent` from the scheduler would be semantically wrong — the document wasn't re-enriched, it just needs re-indexing.
    - Alternatives: Reuse `DocumentEnrichedEvent` for simplicity.
    - Consequences: `DocumentIndexingListener` now listens to both event types; clearer event semantics.
    - Status: Adopted

- Decision: `DocumentIndexingListener` catches all exceptions from `searchService.indexDocument()` and delegates to `markIndexingFailure()`.
    - Why: Matches the pattern used by OCR and enrichment listeners. Prevents unhandled exceptions from killing the async thread.
    - Consequences: Indexing errors are persisted and retried by the recovery scheduler.
    - Status: Adopted

## Progress & changes

### Files modified
- `pdf-core/.../domain/Document.java` — added `INDEXING_IN_PROGRESS`, `INDEXING_COMPLETED`, `INDEXING_ERROR` to Status enum
- `pdf-core/.../dto/document/DocumentStatus.java` — added `INDEXING_IN_PROGRESS`, `INDEXING_COMPLETED` to DTO enum
- `pdf-core/.../events/DocumentIndexingEvent.java` — **new** record for retry re-dispatch
- `pdf-outbound-database/.../entity/DocumentPdfEntity.java` — added `indexingRetryCount`, `indexingNextRetryAt`, `indexingLastError` fields
- `pdf-outbound-database/.../repository/DocumentRepository.java` — added `findRetryableIndexingDocuments()` query
- `pdf-application/.../service/DocumentStatusService.java` — added `markIndexingFailure()` and `resetIndexingRetry()` methods
- `pdf-application/.../processor/DocumentIndexingListener.java` — added status tracking, error handling, and `DocumentIndexingEvent` listener
- `pdf-application/.../processor/FailedDocumentRecoveryScheduler.java` — added indexing retry dispatch

### Tests modified
- `DocumentIndexingListenerTest` — added `StatusTrackingTests` nested class (4 tests: in-progress status, completed status, failure handling, retry event handling)
- `DocumentStatusServiceTest` — added `markIndexingFailure` and `resetIndexingRetry` tests
- `FailedDocumentRecoverySchedulerTest` — updated existing test to include indexing candidates, added dedicated indexing retry test

## Learnings
- **Hibernate `ddl-auto: update` with `NOT NULL` primitives**: When adding a new `int` (not-null) column to an existing table, Hibernate generates `ADD COLUMN ... NOT NULL` but existing rows have NULL. Fix with manual SQL: `ALTER TABLE ... ADD COLUMN ... DEFAULT 0 NOT NULL`.
- **`@Component` on adapter classes**: Not all adapters should be auto-scanned. Infrastructure adapters with external dependencies (Tesseract, specific DB drivers) should use `@ConditionalOnProperty` or explicit `@Bean` configuration to avoid runtime failures when the dependency isn't available.

## What's next (prioritized)
1. Consider adding `@ConditionalOnProperty` to `TessOcrExtractionStrategyImpl` instead of leaving it without `@Component`.
2. End-to-end manual verification: upload PDF, verify `INDEXING_COMPLETED` status, test error path by stopping ES.
3. Continue with UI tasks from todo.md (tag search, pagination).

## Useful snippets
- Manual schema fix for indexing retry columns:
  ```sql
  ALTER TABLE documents ADD COLUMN indexing_retry_count integer DEFAULT 0 NOT NULL;
  ALTER TABLE documents ADD COLUMN indexing_next_retry_at timestamp;
  ALTER TABLE documents ADD COLUMN indexing_last_error varchar(1000);
  ```
- Delete ES index for testing: `curl -X DELETE http://192.168.2.107:9200/documents`
